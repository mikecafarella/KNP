<!--
 * Copyright (c) 2015 Mountainstorm
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 -->
 <html>
	<head>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css">
		<link rel="stylesheet" href="css/graphviz.svg.css">
	</head>

	<style>
        #instructions {
            color: #fcfcfc;
            position: absolute;
            z-index: 100;
            bottom: 0px;
            left: 0px;
        }
    </style>
	<body>
		<h4 id="instructions">Click node to highlight; Shift-scroll to zoom; Esc to unhighlight</h4>
		<div id="graph" style="width: 100%; height: 100%; overflow: scroll;"></div>

		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/jquery/jquery-mousewheel/master/jquery.mousewheel.min.js"></script>
		<script type="text/javascript" src="https://cdn.rawgit.com/jquery/jquery-color/master/jquery.color.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/jquery.graphviz.svg.js"></script>
		<script type="text/javascript">
 			$(document).ready(function(){
                $("#graph").graphviz({
                    url: "graph1.svg", 
                    ready: function() {
                        var gv = this
                        gv.nodes().attr("data-collapse", 0)
                        gv.nodes().attr("data-collapsed", false)
                        var le = gv.edges()
                        for (var i=0; i<le.length; ++i) {                           
                            var s = le[i].getAttribute("data-name")
                            le[i].setAttribute("data-s", s.substring(0, s.indexOf("-")))
                            le[i].setAttribute("data-t", s.substring(s.indexOf(">") + 1, s.length))
                        }
                        //console.log(gv.nodesByName())
                        //console.log(gv.edges())
                        update();

                        function update() {
                            var ln = gv.nodes()
                            for (var i = 0; i < ln.length; ++i) {
                                if (ln[i].getAttribute("data-collapse") != 0) {
                                    ln[i].style.visibility = "hidden"
                                }
                                else {
                                    ln[i].style.visibility = "visible"
                                    ln[i].onclick = function () {
                                        console.log("clicked")
                                        var collapsed = this.getAttribute("data-collapsed")
                                        var inc = (collapsed == "true") ? -1 : 1;
                                        console.log(inc)
                                        recurse(this);
                            
                                        function recurse(s) {
                                            var le = gv.edges()
                                            for (var i = 0; i < le.length; ++i) {
                                                f(le[i], s)
                                            }
                                        }

                                        function f(l, s) {
                                            var lsid = l.getAttribute("data-s")
                                            var sid = s.getAttribute("data-name")
                                            if (sid === lsid) {
                                                var lt = gv.nodesByName()[l.getAttribute("data-t")]
                                                var ltc = lt.getAttribute("data-collapse")
                                                lt.setAttribute("data-collapse",parseInt(ltc)+inc)
                                                recurse(lt)
                                            }
                                        }

                                    this.setAttribute("data-collapsed", !(collapsed == "true"))
                                    /*var $set = $()
                                    $set.push(this)
                                    $set = $set.add(gv.linkedFrom(this, true))
                                    $set = $set.add(gv.linkedTo(this, true))
                                    gv.highlight($set, true)
                                    gv.bringToFront($set)*/
                                    update();
                                }
                            }
                        }

                        var le = gv.edges()
                        for (var i = 0; i < le.length; ++i) {
                            var source = gv.nodesByName()[le[i].getAttribute("data-s")];
                            var target = gv.nodesByName()[le[i].getAttribute("data-t")];
                            if (!(source.getAttribute("data-collapse") == 0 && target.getAttribute("data-collapse") == 0)) {
                                le[i].style.visibility = "hidden"
                            }
                            else {
                                le[i].style.visibility = "visible"
                            }
                        }


                        // iterate through all clusters
                        var clusters = document.getElementsByClassName("cluster");
                        for (var i = 0; i < clusters.length; ++i) {
                            //console.log(clusters[i].outerHTML.match(/<title>(.*?)<\/title>/)[1]);
                            //console.log(clusters[i].firstChild.innerHTML);
                            var title = clusters[i].outerHTML.match(/<title>(.*?)<\/title>/)[1];
                            var ulist = [];
                            for (var j = 0; j < title.length; ++j) {
                                if (title.charAt(j) == "_") {
                                    ulist.push(j)
                                }
                            }

                            var id_list = []
                            for (var j = 0; j < ulist.length - 1; ++j) {
                                id_list.push(parseInt(title.substring(ulist[j]+1, ulist[j+1])))
                            }
                            
                            var flag = false; // hidden
                            for (var j = 0; j < id_list.length; ++j) {
                                console.log(id_list[j]);
                                var name = "val" + id_list[j].toString();
                                console.log(name);
                                console.log(gv.nodesByName());
                                var status = gv.nodesByName()[name].getAttribute("data-collapse")
                                if (status == 0){ // not hidden
                                    flag = true // not hidden
                                }
                            }

                            if (!flag) { // hidden
                                clusters[i].style.visibility = "hidden"
                            }
                            else {
                                clusters[i].style.visibility = "visible"
                            }
                        }
                    }
                        /*console.log(gv.nodes())
                        gv.nodes().click(function () {
                            console.log("clicked")
                            var collapsed = this.getAttribute("data-collapsed")
                            var inc = (collapsed == true) ? -1 : 1;
                            console.log(inc)
                            recurse(this);
                            
                            function recurse(s) {
                                gv.edges().each(
                                    l => {
                                        var lsid = l.getAttribute("data-s")
                                        var sid = s.getAttribute("data-name")
                                        if (sid === lsid) {
                                            var lt = gv.nodesByName()[l.getAttribute("data-t")]
                                            var ltc = lt.getAttribute("data-collapse")
                                            lt.setAttribute("data-collapse",parseInt(ltc)+inc)
                                            recurse(lt)
                                        }
                                    }
                                )
                            }

                            this.setAttribute("data-collapsed", !(collapsed == true))
                            var $set = $()
                            $set.push(this)
                            $set = $set.add(gv.linkedFrom(this, true))
                            $set = $set.add(gv.linkedTo(this, true))
                            gv.highlight($set, true)
                            gv.bringToFront($set)
                        }) */
                        gv.nodes().dblclick(function() {
                            var url = this.attributes[2].value;
                            url = url.substring(0, 3) + "/" + url.substring(3, url.length);
                            console.log(url)
                            window.open(url, "_blank")
                        })
                        $(document).keydown(function (evt) {
                            if (evt.keyCode == 27) {
                                gv.highlight()
                            }
                        })
                    }
                });
            });
		</script>
	</body>
</html>